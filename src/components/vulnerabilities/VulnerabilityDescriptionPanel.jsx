import { useSystemCustomFieldsQuery } from "api/system.js";
import CvssScore from "components/badges/CvssScore";
import RiskBadge from "components/badges/RiskBadge";
import ProjectBadge from "components/projects/ProjectBadge";
import TargetBadge from "components/target/TargetBadge";
import EmptyField from "components/ui/EmptyField";
import ExternalLink from "components/ui/ExternalLink";
import TimestampsSection from "components/ui/TimestampsSection";
import UserLink from "components/users/Link";
import { Fragment, useEffect, useState } from "react";
import ReactMarkdown from "react-markdown";
import { Link } from "react-router-dom";
import VulnerabilityCategorySpan from "./categories/Span";
import CvssAbbr from "./CvssAbbr";
import VulnerabilityStatusBadge from "./StatusBadge";

const VulnerabilityDescriptionPanel = ({ vulnerability }) => {
    const { data: customFieldDefinitions } = useSystemCustomFieldsQuery();
    const customFields = JSON.parse(vulnerability.customFields);

    const [names, setNames] = useState(null);

    useEffect(() => {
        if (customFieldDefinitions) {
            setNames(Object.fromEntries(customFieldDefinitions.map(({ name, label }) => [name, label])));
        }
    }, [customFieldDefinitions]);

    return (
        <div className="grid grid-two">
            <div className="content">
                <h4>Description</h4>
                {vulnerability.description ? (
                    <ReactMarkdown>{vulnerability.description}</ReactMarkdown>
                ) : (
                    <EmptyField />
                )}

                <h4>Proof of concept</h4>
                {vulnerability.proofOfConcept ? (
                    <ReactMarkdown>{vulnerability.proofOfConcept}</ReactMarkdown>
                ) : (
                    <EmptyField />
                )}

                <h4>Impact</h4>
                {vulnerability.impact ? <ReactMarkdown>{vulnerability.impact}</ReactMarkdown> : <EmptyField />}

                <h4>Category</h4>
                <p>
                    <VulnerabilityCategorySpan
                        name={vulnerability.category?.name}
                        parentName={vulnerability.parent_category_name}
                    />
                </p>

                <h4>Properties</h4>
                <dl>
                    <dt>Status</dt>
                    <dd>
                        <VulnerabilityStatusBadge vulnerability={vulnerability} />
                    </dd>

                    <dt>Risk</dt>
                    <dd>
                        <RiskBadge risk={vulnerability.risk} />
                    </dd>

                    {vulnerability.cvssScore && (
                        <>
                            <dt>
                                <CvssAbbr /> score
                            </dt>
                            <dd>
                                <CvssScore score={vulnerability.cvssScore} />
                            </dd>
                        </>
                    )}

                    {vulnerability.cvssVector && (
                        <>
                            <dt>CVSS vector</dt>
                            <dd>
                                <ExternalLink
                                    href={`https://www.first.org/cvss/calculator/3.0#${vulnerability.cvssVector}`}
                                >
                                    {vulnerability.cvssVector}
                                </ExternalLink>
                            </dd>
                        </>
                    )}

                    {vulnerability.owaspVector && (
                        <>
                            <dt>OWASP vector</dt>
                            <dd>{vulnerability.owaspVector}</dd>
                        </>
                    )}
                    {vulnerability.owaspOverall && (
                        <>
                            <dt>OWASP overall score</dt>
                            <dd>{vulnerability.owaspOverall}</dd>
                        </>
                    )}
                    {vulnerability.owaspLikelihood && (
                        <>
                            <dt>OWASP likehood score</dt>
                            <dd>{vulnerability.owaspLikelihood}</dd>
                        </>
                    )}
                    {vulnerability.owaspImpact && (
                        <>
                            <dt>OWASP impact score</dt>
                            <dd>{vulnerability.owaspImpact}</dd>
                        </>
                    )}
                </dl>

                {customFields && names && (
                    <>
                        <h4>Custom fields</h4>

                        <dl>
                            {Object.entries(customFields).map(([k, v]) => (
                                <Fragment key={k}>
                                    <dt>{names[k]}</dt>
                                    <dd>{v}</dd>
                                </Fragment>
                            ))}
                        </dl>
                    </>
                )}
            </div>

            <div className="content">
                <h4>Relations</h4>
                <dl>
                    {!vulnerability.is_template && (
                        <>
                            <dt>Project</dt>
                            <dd>
                                {vulnerability.projectId ? (
                                    <ProjectBadge
                                        project={{ id: vulnerability.projectId, name: vulnerability.project?.name }}
                                    />
                                ) : (
                                    "-"
                                )}
                            </dd>
                        </>
                    )}

                    {vulnerability.targetId !== null && vulnerability.targetId !== 0 && (
                        <>
                            <dt>Affected target</dt>
                            <dd>
                                <Link to={`/targets/${vulnerability.targetId}`}>
                                    <TargetBadge name={vulnerability.asset?.name}>
                                        {vulnerability.targetId
                                            ? `${vulnerability.asset?.name} (${vulnerability.asset?.kind})`
                                            : "-"}
                                    </TargetBadge>
                                </Link>
                            </dd>
                        </>
                    )}

                    <dt>Created by</dt>
                    <dd>
                        <UserLink userId={vulnerability.createdByUid}>{vulnerability.createdBy?.fullName}</UserLink>
                    </dd>
                </dl>

                <TimestampsSection entity={vulnerability} />
            </div>
        </div>
    );
};

export default VulnerabilityDescriptionPanel;
